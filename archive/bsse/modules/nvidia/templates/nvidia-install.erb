#!/bin/bash
#
# This file was autogenerated on <%= File.mtime("#{file}").strftime("%m/%d/%Y %T %Z") %> # by puppet <%= @puppetversion %>
# It can still be managed manually but will be overwritten on the next run.
# SVN <%= %x(svn info #{file} | grep Revision | tr -d "\n")%>
#

# hw-nvidia-NVS v340.xy for most NVS 290 - 315, 420, 450, 510 

# hw-nvidia-cuda v35x.yz for tesla card with CUDA support

# hw-nvidia-driver v36x.yz or higher, for newer graphic cards


<% if scope.lookupvar("::hostname") =~ /bs-gpu04/ -%># old nvidia system graphic card installed
NVIDIAPKGVERSION=304.135
<% else -%>
NVIDIAPKGVERSION=<%= @nvidiaversion %>
<% end -%>

NVIDIAPKG=NVIDIA-Linux-x86_64-${NVIDIAPKGVERSION}.run
NVIDIAINSTDIR=/usr/src/nvidia
NVIDIADRVLNK=/usr/src/nvidia-driver

logger start nvidia-install.sh

lspci|grep NVIDIA
if [ $? == 1 ]; then 
	logger nvidia-install.sh: no NVIDIA card found
	exit 0
fi

if [ ! -f "/root/preinst_nvidia.done" ]; then

	logger nvidia-install.sh: start preinst_nvidia

	yum erase -y nvidia-x11-drv kmod-nvidia xorg-x11-drivers xorg-x11-drv-nouveau

	echo -e "blacklist nouveau\noptions nouveau modeset=0" > /etc/modprobe.d/blacklist-nouveau.conf

	if [ -f "/etc/grub.conf/" ]; then
		sed -i "s/nouveau.modeset=0/nouveau.modeset=0 rd.driver.blacklist=nouveau/" /etc/grub.conf
	grub-mkconfig -o /etc/grub.cfg
	fi

	if [ -f "/etc/grub2.conf/" ]; then
		sed -i "s/nouveau.modeset=0/nouveau.modeset=0 rd.driver.blacklist=nouveau/" /etc/grub2.conf
	grub2-mkconfig -o /etc/grub2.cfg
	fi

	cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak

	dracut -f /boot/initramfs-$(uname -r).img $(uname -r)

	touch /root/preinst_nvidia.done

	logger nvidia-install.sh: done preinst_nvidia

	reboot

fi

if [ -f "/root/preinst_nvidia.done" ] && [ ! -f "/root/inst_nvidia.done" ]; then

	logger nvidia-install.sh: start inst_nvidia

	cat /etc/redhat-release|grep "release 6."
	if [ $? == 0 ]; then 
		init 3
	else
		systemctl stop display-manager
	fi

	cd /root/

	if [ ! -d ${NVIDIAINSTDIR} ]; then
        	mkdir -p ${NVIDIAINSTDIR};
	fi

	if [ ! -f ${NVIDIAPKG} ]; then
        	wget http://us.download.nvidia.com/XFree86/Linux-x86_64/${NVIDIAPKGVERSION}/${NVIDIAPKG};
	        if [ ! -f ${NVIDIAPKG} ]; then
			logger nvidia-install.sh: nvidia download failed;
			exit 1;
		fi
	fi

	cp ${NVIDIAPKG} ${NVIDIAINSTDIR}/
	chmod 755 ${NVIDIAINSTDIR}/${NVIDIAPKG}

	if [ -h ${NVIDIADRVLNK} ]; then
        	rm -f ${NVIDIADRVLNK};
	fi

	ln -s ${NVIDIAINSTDIR}/${NVIDIAPKG} ${NVIDIADRVLNK};

	sh ${NVIDIADRVLNK} -qaXs

	if [ $? != 0 ]; then
		logger nvidia driver install failed;
		exit 1;
	fi

	touch /root/inst_nvidia.done

	logger nvidia-install.sh: done inst_nvidia

	reboot

fi

logger nvidia-install.sh: end nvidia-install.sh: nothing to do
/root/bin/nvidia.sh

sleep 2

cat /etc/redhat-release|grep "release 7."
if [ $? == 0 ]; then 
	systemctl start display-manager
fi


exit 0

